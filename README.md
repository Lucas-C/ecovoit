A French carpooling search engine.


## Live instance

[https://chezsoi.org/ecovoit](//chezsoi.org/ecovoit)


## Runtime dependencies
- [Python Requests](http://python-requests.org/) : for the WSGI proxy script
- [Lo-Dash](//lodash.com) : a functional programming Javascript utility library
- [Twitter Bootstrap](http://getbootstrap.com) : front-end framework for HTML & CSS
- [Bootstrap-datepicker](//github.com/eternicode/bootstrap-datepicker) & [Bootstrap-table](//github.com/wenzhixin/bootstrap-table) : 2 plugins requiring [jQuery](http://jquery.com)
- [Google Maps Places](//developers.google.com/places/documentation) : for its autocomplete functionality
- [SugarJS](http://sugarjs.com) : for its date parsing module. The file  _sugar-1.4.1\_date\_locale-fr.min.js_ is the 'dev' minimal version of SugarJS Date module + the French locale customized build, minimized using the Clojure compiler.

### Build dependencies
make, browserify, david, madge, piprot, uwsgi

### Static checking dependencies
jshint, pylint, jscs, pep8, bootlint, Nu Markup Checker (v.Nu)

### Tests dependencies
tape, pytest, WebTest


## Architecture

### Overview

Once the user has specified the search parameters, AJAX requests are made to the carpooling websites, and the responses are parsed in Javascript to extract the rides information. Because of the [Same-origin policy](//developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy), those AJAX requests are proxied, but all the parsing logic is still done on the client side.

<img src="http://chezsoi.org/ecovoit/doc/diagram_archi_proxy.png" alt="AJAX-through-proxy diagram">

### Javascript modules

They are following the [Node.js convention](//github.com/substack/browserify-handbook#node-packaged-modules) and are bundled by [browserify](http://browserify.org).

The following diagram represents their dependencies. It can been generated by invoking `make deps-graph`.

<figure>
    <img src="http://chezsoi.org/ecovoit/doc/dependencies_graph.png" alt="Graph of JS modules dependencies">
    <figcaption><small>
    'require' dependencies, except a couple of very common base modules, with only 2 crawlers included
    <small></figcaption>
</figure>
<br>

Beware that this does not reveal all the modules ties. E.g. *form\_header.js* is passed the *results\_viewer.js* module and invokes some of its methods but don't include it directly.

### Crawlers

A crawler is a Javascript module, living in the *crawlers/* source directory, dedicated to scrape a single carpooling website. It must respect its _robotos.txt_.

The crawlers modules share a common API, i.e. a list of properties:
* `.DISPLAY_NAME` _[mandatory]_
* `.TAG_NAME` _[mandatory]_
* `.WEBSITE_URL` _[mandatory]_
* `.NEED_LAT_LNG` _[default:*false*]_
* `.HIDDEN_COLUMNS` _[default:*[]*]_
* `.SORT_NAME` _[default:*'departure\_hour'*]_
* `.SORT_ORDER` _[default:*'asc'*]_

Moreover, each crawler must have a `.CALLBACKS_PIPELINE` array property, consisting of an ordered list of callback functions:
    * each function must accept a `cb_chain` as first argument
    * each callback execution must end with a call to `cb_chain.next(_args, _for, _next, _callback)`
    * the first callback is passed a `user_input` dictionary object as first argument, and then a `lat_lng` object if it defines `NEED_LAT_LNG`
    * the last callback must invoke `cb_chain.next` with 3 arguments: (crawler, rides, query_params)

Finally, each crawler must define a  `.remote_search_links(query_params)` function returning either a single string or a dictionary `{link_name: link_href})`.

#### LeBonCoin.fr specificities

Rides on this website are registered by users in a very <strike>chaotic</strike> free-form way. There are 2 methods to get results: queries based on a {searchtext} and queries base on a {location}. The crawler gather rides from both methods.

By default, LeBonBoin.fr search results do not include the ride date, only the ad publication date. Rarely, the author will include the ride date in its ad short description. Similarly, the information on the ride price & driver are often only displayed on the ad page itself.

Because so much structured information is missing, we use the following algorithm to filter out parasite results:
- if a ride date can be extract, discard the ad in the search results if it contains none of the departure / arrival cities in its description
- if no ride date can be extracted, discard any ad that do not contain both the departure & arrival cities


## Installation

You will need [`npm`](//github.com/npm/npma) and [`pip`](//pip.pypa.io/en/latest/) to install the needed libraries and tools.

Then, simply invoke `make install` to install everything from the _requirements.txt_ and _package.json_ files.

### Apache mod_wsgi

For now, I only tested deploying this website with Apache. Once the server is configured with [`mod_wsgi`](//modwsgi.readthedocs.org), just add the following line to its configuration. Assuming you've allowed Apache to serve the other static files in the project directory, it should just work.

    WSGIScriptAlias /ecovoit/proxy /var/www/ecovoit/proxy.py


## Tests

### Manual execution

    make check # => check-static check-style check-html
    make test-proxy # execute the unit tests for the Python proxy
    make view-js-tests # generate the Javascript unit tests, and open index-tests.html in a browser to execute them

To execute Javascript tests selectively, you can pass a regular expression as query string to _index-tests.html_, e.g. :

    http://localhost:8080/index-tests.html?full-blackbox-test

Note: currently unit tests actually include integration tests, that is tests requiring an Internet connexion and effectively querying websites.

### Continuous Integration Status

This project uses `testling` to run the tests in several browser at once on every push:
[![browser support](//ci.testling.com/Lucas-C/ecovoit.png)](//ci.testling.com/Lucas-C/ecovoit)

Issue tracker metrics: [![Average time to resolve an issue](http://isitmaintained.com/badge/resolution/Lucas-C/ecovoit.svg)](http://isitmaintained.com/project/Lucas-C/ecovoit "Average time to resolve an issue") - [![Percentage of issues still open](http://isitmaintained.com/badge/open/Lucas-C/ecovoit.svg)](http://isitmaintained.com/project/Lucas-C/ecovoit "Percentage of issues still open")


## Logo
Credit goes to the amazing [Laetitia Beschus](http://laetitiabeschus.weebly.com) for the artwork.


## License
Creative Commons Attribution NonCommercial (CC-BY-NC)

Tl;dr plain English version: https://tldrlegal.com/license/creative-commons-attribution-noncommercial-(cc-nc)
